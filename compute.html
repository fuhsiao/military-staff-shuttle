<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>訓員專車統計小幫手</title>
</head>
<body>
    <span>選擇站別</span>
    <select id="place_selector"></select>
    <span>選擇訓員</span>
    <select id="staff_selector" multiple="multiple" onchange="addStaff(this)"></select>
    <textarea id="result" readonly ></textarea>
    <button onclick="copyResult()">複製結果</button>
    <a href="index.html">選單設定</a>
    <a href="check.html">費用清點</a>

    <script src="script.js"></script>
    <script>
        const StaffList = document.getElementById("staff_selector");
        const PlaceList = document.getElementById("place_selector");

        for(let i = 1; i < StaffNumber + 1; i++) {
            let pid = String(i).padStart(3, '0');
            let option = new Option(pid, pid); 
            StaffList.appendChild(option)
        }

        for(let i = 0; i < StationList.length; i++) {
            let option = new Option(StationList[i].place, StationList[i].price)
            PlaceList.appendChild(option)
        }

        function updateStationList(staffArr) {
            for(let i = 0; i < staffArr.length; i++){
                let index = StationList.findIndex(s => s.passenger.includes(staffArr[i]));
                if (index > -1){
                    let staffIndex = StationList[index].passenger.indexOf(staffArr[i])
                    StationList[index].passenger.splice(staffIndex,1)
                }
            }

            let place = PlaceList.options[PlaceList.selectedIndex].text
            for(let i = 0; i < StaffList.length; i++){
                if(StationList[i].place == place) {
                    StationList[i].passenger = staffArr
                    updateStaffList_placeInfo(staffArr, place)
                    return
                }
            }
        }

        function updateStaffList_placeInfo(staffArr, place){         
            for(let i = 0; i < StaffList.length; i++){

                if(staffArr.includes(StaffList.options[i].value)){
                    StaffList.options[i].text = StaffList.options[i].value + ' - ' + place
                }
                else if(StaffList.options[i].text.includes(place)){
                    StaffList.options[i].text = StaffList.options[i].value
                }
                
            }
                 
            
        }

        function addStaff(e) {
            let staff = []
            for(let i = 0; i < e.options.length; i++){
                
                if(e.options[i].selected) {
                    staff.push(e.options[i].value)
                }
            }
            updateStationList(staff)
            printResult()
        }

        function getStaffByPlace() {
            let place = PlaceList.options[PlaceList.selectedIndex].text
            for(let i = 0; i < StaffList.length; i++){
                if(StationList[i].place == place) {
                    return StationList[i].passenger
                }
            }
        }

        function printResult() {
            let result = document.getElementById('result');
            result.textContent = ''
            let text = ''
            let text2 = ''
            let amount = [0, 0]

            for(let i = 0; i < StationList.length; i++){
                
                let place = StationList[i].place
                let price = StationList[i].price
                let passenger = StationList[i].passenger
                
                for(let j = 0; j < passenger.length; j++){
                    if(j == 0){
                        text += place + '($' + price + ') : ';
                    }
                    if(j < passenger.length - 1){
                        text += passenger[j] + ', ';
                    }
                    else{
                        text += passenger[j] + '\n'
                    }    
                }
                
                if(passenger.length > 0){
                    text2 += place + ' 共 ' + passenger.length + '員 搭乘 ($' + price*passenger.length + ')\n'
                    amount[0] += passenger.length
                    amount[1] += passenger.length*price
                }
                
            }

            result.textContent += text + '==================' + '\n' + text2 + '\n';
            result.textContent += '專車人數 共 ' + amount[0] + ' 員' + '\n'
            result.textContent += '專車費用 共 ' + amount[1] + ' 元'

            for(let i = 0; i < StationList.length; i++){

            }


            result.style.height = 'auto';
            result.style.height = result.scrollHeight + 'px';
        }

        function copyResult(e){
            document.getElementById('result').select();
            document.execCommand('copy');
            alert("已複製 統計結果")
        }

        PlaceList.addEventListener('change', function(){
            for(let i = 0; i < StaffList.length; i++){
                StaffList[i].selected = false
            }

            let staff = getStaffByPlace()
            for(let i = 0; i < StaffList.length; i++){
                if(staff.includes(StaffList[i].value)){
                    StaffList[i].selected = true
                }   
            }
        })



    </script>
</body>
</html>